<!doctype html>
<html
  lang="de"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="light"
  data-auto-appearance="true"><head>
  <meta charset="utf-8">
  
    <meta http-equiv="content-language" content="de-de">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color">

  
  
    <title>Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes &middot; Zyria</title>
    <meta name="title" content="Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes &middot; Zyria">
  

  
  
    <meta name="description" content="Ein technischer Leitfaden für das geordnete Herunterfahren und Wiederanfahren eines Kubernetes-Clusters (k3s/Longhorn/ArgoCD) zur Vermeidung von Datenkorruption.">
  
  
    <meta name="keywords" content="k3s,longhorn,argocd,ansible,recovery,">
  
  
  
  <link rel="canonical" href="https://zyria.de/posts/homelab/k3s-prod/ansible/shutdown-startup/">
  

  
  
    <meta name="author" content="Fabrice Kirchner">
  
  
    
      
        
      
    
      
        
          <link href="https://git.casa-due-pur.de/fabrice.kirchner" rel="me">
        
      
    
      
        
          <link href="https://git.zyria.de/pyrox" rel="me">
        
      
    
      
        
          <link href="https://github.com/ricariel" rel="me">
        
      
    
      
        
          <link href="https://www.linkedin.com/in/fabrice-kirchner-bb5408163/" rel="me">
        
      
    
      
        
          <link href="https://www.xing.com/profile/Fabrice_Kirchner" rel="me">
        
      
    
      
        
          <link href="https://kirchner.social/@fabrice" rel="me">
        
      
    
      
        
          <link href="https://codeberg.org/ricariel" rel="me">
        
      
    
  

  
  <meta property="og:url" content="https://zyria.de/posts/homelab/k3s-prod/ansible/shutdown-startup/">
  <meta property="og:site_name" content="Zyria">
  <meta property="og:title" content="Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes">
  <meta property="og:description" content="Ein technischer Leitfaden für das geordnete Herunterfahren und Wiederanfahren eines Kubernetes-Clusters (k3s/Longhorn/ArgoCD) zur Vermeidung von Datenkorruption.">
  <meta property="og:locale" content="de_de">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-10-27T10:00:00+01:00">
    <meta property="article:modified_time" content="2026-02-16T01:12:21+01:00">
    <meta property="article:tag" content="K3s">
    <meta property="article:tag" content="Longhorn">
    <meta property="article:tag" content="Argocd">
    <meta property="article:tag" content="Ansible">
    <meta property="article:tag" content="Recovery">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes">
  <meta name="twitter:description" content="Ein technischer Leitfaden für das geordnete Herunterfahren und Wiederanfahren eines Kubernetes-Clusters (k3s/Longhorn/ArgoCD) zur Vermeidung von Datenkorruption.">

  
  
  
  
    
      
    
  
    
      
    
  
    
      
    
  
  
    
  

  
  
  
  
  
  

  

  
  
  
  
  
  
  
    
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.17fbd824c7516cef8281e9f24caca1c33acc3daf51d6805e14e8e0b4ded263e6a6df8a7357b5f6d18e5ce090bf096b7a8baffbbd0c60e76359c939e6c50343f2.css"
    integrity="sha512-F/vYJMdRbO&#43;CgenyTKyhwzrMPa9R1oBeFOjgtN7SY&#43;am34pzV7X20Y5c4JC/CWt6i6/7vQxg52NZyTnmxQND8g==">

  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js"
    integrity="sha512-b0EXSzoFtoCCD&#43;CMrb&#43;l&#43;3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script>
  
  
  
  
  
    
    <script
      type="text/javascript"
      src="/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js"
      integrity="sha512-mBTe6WFNMq61YjnRGO3&#43;IKzWIxQk&#43;bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script>
  
  
    
    <script src="/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js" integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7&#43;kfJ6kKCJxQGC&#43;8wm&#43;Bz9JucDjDTGNew=="></script>
  

  
  
  
    
  
  
    
  
  
    
  
  
  
  
  
    
    <script
      defer
      type="text/javascript"
      id="script-bundle"
      src="/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js"
      integrity="sha512-vdp97ObLrwje730lT3&#43;ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w=="
      data-copy="Kopieren"
      data-copied="Kopiert"></script>
  

  
  
























  

  

  

  

  













  
  
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">


<link
rel="manifest"
href="/site.webmanifest.min.7a9e07ce1f7386689917602ddc5a75750ad842e605ff764f67173529c181bf04.json"

  integrity="sha256-ep4Hzh9zhmiZF2At3Fp1dQrYQuYF/3ZPZxc1KcGBvwQ="

/>

<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

  

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Beiträge",
    "name": "Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes",
    "headline": "Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes",
    
    "inLanguage": "de-de",
    "url" : "https://zyria.de/posts/homelab/k3s-prod/ansible/shutdown-startup/",
    "author" : {
      "@type": "Person",
      "name": "Fabrice Kirchner"
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-10-27T10:00:00\u002b01:00",
    "datePublished": "2024-10-27T10:00:00\u002b01:00",
    
    "dateModified": "2026-02-16T01:12:21\u002b01:00",
    
    "keywords": ["k3s","longhorn","argocd","ansible","recovery"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1818"
  }]
  </script>



  
  
    




  

  
  

  
  

  
  
</head>


















  
  <body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar">
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        Zum Hauptinhalt springen
      </a>
    </div>
    
    
      <div class="main-menu flex items-center w-full gap-2 p-1 pl-0">
  
  
    <a href="/" class="text-base font-medium truncate min-w-0 shrink">
      Zyria
    </a>
  
  <div class="flex items-center ms-auto">
    <div class="hidden md:flex">
      <nav class="flex items-center gap-x-5 h-12">
  
    
      
  
    <a
      href="/about/"
      
      class="flex items-center bf-icon-color-hover"
      aria-label="Über mich"
      title="Über mich">
      
      
        <span class="text-base font-medium break-normal">
          Über mich
        </span>
      
    </a>
  

    
      
  
    <a
      href="/posts/"
      
      class="flex items-center bf-icon-color-hover"
      aria-label="Beiträge"
      title="Beiträge">
      
      
        <span class="text-base font-medium break-normal">
          Beiträge
        </span>
      
    </a>
  

    
      
  
    <a
      href="/datenschutz/"
      
      class="flex items-center bf-icon-color-hover"
      aria-label="Datenschutzerklärung"
      title="Datenschutzerklärung">
      
      
        <span class="text-base font-medium break-normal">
          Datenschutzerklärung
        </span>
      
    </a>
  

    
      
  
    <a
      href="/impressum/"
      
      class="flex items-center bf-icon-color-hover"
      aria-label="Impressum"
      title="Impressum">
      
      
        <span class="text-base font-medium break-normal">
          Impressum
        </span>
      
    </a>
  

    
      
  
    <a
      href="https://status.zyria.de"
      
        target="_blank"
      
      class="flex items-center bf-icon-color-hover"
      aria-label="Statusseite"
      title="">
      
      
        <span class="text-base font-medium break-normal">
          Statusseite
        </span>
      
    </a>
  

    
  

  

  

  
    <button
      id="search-button"
      aria-label="Search"
      class="text-base bf-icon-color-hover"
      title="Suche (/)">
      <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
    </button>
  

  
    <div class="flex items-center">
      <button
        id="appearance-switcher"
        aria-label="Dark mode switcher"
        type="button"
        class="text-base bf-icon-color-hover">
        <div class="flex items-center justify-center dark:hidden">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
        </div>
        <div class="items-center justify-center hidden dark:flex">
          <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
        </div>
      </button>
    </div>
  
</nav>



    </div>
    <div class="flex md:hidden">
      <div class="flex items-center h-14 gap-4">
  
    <button
      id="search-button-mobile"
      aria-label="Search"
      class="flex items-center justify-center bf-icon-color-hover"
      title="Suche (/)">
      <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
    </button>
  

  
    <button
      id="appearance-switcher-mobile"
      type="button"
      aria-label="Dark mode switcher"
      class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400">
      <div class="dark:hidden">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>
</span>
      </div>
      <div class="hidden dark:block">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>
</span>
      </div>
    </button>
  

  
    <input type="checkbox" id="mobile-menu-toggle" autocomplete="off" class="hidden peer">
    <label for="mobile-menu-toggle" class="flex items-center justify-center cursor-pointer bf-icon-color-hover">
      <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>
</span>
    </label>

    <div
      role="dialog"
      aria-modal="true"
      style="scrollbar-gutter: stable;"
      class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
      bf-scrollbar">
      <label
        for="mobile-menu-toggle"
        class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </label>
      <nav class="mx-auto max-w-md space-y-6">
        
  
    
    <div class="px-2">
      <a
        href="/about/"
        aria-label="Über mich"
        
        class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200">
        
        <span title="Über mich" class="text-2xl font-bold tracking-tight">
          Über mich
        </span>
        
      </a>

      
    </div>
  
    
    <div class="px-2">
      <a
        href="/posts/"
        aria-label="Beiträge"
        
        class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200">
        
        <span title="Beiträge" class="text-2xl font-bold tracking-tight">
          Beiträge
        </span>
        
      </a>

      
    </div>
  
    
    <div class="px-2">
      <a
        href="/datenschutz/"
        aria-label="Datenschutzerklärung"
        
        class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200">
        
        <span title="Datenschutzerklärung" class="text-2xl font-bold tracking-tight">
          Datenschutzerklärung
        </span>
        
      </a>

      
    </div>
  
    
    <div class="px-2">
      <a
        href="/impressum/"
        aria-label="Impressum"
        
        class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200">
        
        <span title="Impressum" class="text-2xl font-bold tracking-tight">
          Impressum
        </span>
        
      </a>

      
    </div>
  
    
    <div class="px-2">
      <a
        href="https://status.zyria.de"
        aria-label="Statusseite"
        
          target="_blank"
        
        class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200">
        
        <span title="" class="text-2xl font-bold tracking-tight">
          Statusseite
        </span>
        
      </a>

      
    </div>
  

        
  

        
  

      </nav>
    </div>
  
</div>







    </div>
  </div>
</div>





    
    <div class="relative flex flex-col grow">
      <main id="main-content" class="grow">
        
  
  <article>
    
    
      
      
      
      
        







  
  
    
  
    
  
    
  
    
  



  
  




  




      
    

    
    <header id="single_header" class="mt-5 max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
    
  
    
  
  <li class="hidden">
    <a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/"
      >Eine (scheinbar) leere Homepage</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline">
    <a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/"
      >Beiträge</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline">
    <a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/homelab/"
      >Kleines Homelab</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline">
    <a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/homelab/k3s-prod/"
      >k3s-prod: Kubernetes Cluster Konfiguration und Anwendungsbereitstellung</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden">
    <a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/homelab/k3s-prod/ansible/shutdown-startup/"
      >Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Operational Lifecycle Management: Orchestrierter Shutdown für Kubernetes
      </h1>
      <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        





  
  



  

  
  
  
    
  

  

  
    
  

  
    
  

  
    
  

  

  

  

  

  
    
  

  
    
  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2024-10-27T10:00:00&#43;01:00">27 Oktober 2024</time><span class="px-2 text-primary-500">&middot;</span><time datetime="2026-02-16T01:12:21&#43;01:00">Aktualisiert: 16 Februar 2026</time><span class="px-2 text-primary-500">&middot;</span><span>1818 Wörter</span><span class="px-2 text-primary-500">&middot;</span>


  
  

<span class="mb-[2px]">
  <a
    href="https://git.zyria.de/pyrox/zyria_de/src/branch/main/content/posts/homelab/k3s-prod/ansible/shutdown-startup.md"
    class="text-lg hover:text-primary-500"
    rel="noopener noreferrer"
    target="_blank"
    title="Inhalt bearbeiten"
    ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1l-58.5 16.7 16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z"/></svg></span></span></a
  >
</span><span class="px-2 text-primary-500">&middot;</span><span class="mb-[2px]">
  <span
    id="zen-mode-button"
    class="text-lg hover:text-primary-500"
    title="Zen-Modus aktivieren"
    data-title-i18n-disable="Zen-Modus aktivieren"
    data-title-i18n-enable="Zen-Modus deaktivieren">
    <span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="50px" height="50px">
    <path fill="currentColor" d="M 12.980469 4 C 9.1204688 4 5.9804688 7.14 5.9804688 11 L 6 26 L 9.9804688 26 L 9.9804688 11 C 9.9804688 9.35 11.320469 8 12.980469 8 L 40.019531 8 C 41.679531 8 43.019531 9.35 43.019531 11 L 43.019531 39 C 43.019531 40.65 41.679531 42 40.019531 42 L 29 42 C 29 43.54 28.420938 44.94 27.460938 46 L 40.019531 46 C 43.879531 46 47.019531 42.86 47.019531 39 L 47.019531 11 C 47.019531 7.14 43.879531 4 40.019531 4 L 12.980469 4 z M 7 28 C 4.794 28 3 29.794 3 32 L 3 42 C 3 44.206 4.794 46 7 46 L 23 46 C 25.206 46 27 44.206 27 42 L 27 32 C 27 29.794 25.206 28 23 28 L 7 28 z M 7 32 L 23 32 L 23.001953 42 L 7 42 L 7 32 z"/>
</svg></span></span>
  </span>
</span>

    

    
    
  </div>

  
    <div class="flex flex-row flex-wrap items-center">
      
        
          
        
      
        
      
        
      
        
      
    </div>
  

  
  
    <div class="flex flex-row flex-wrap items-center">
      
        
      
        
          
            
              <a class="relative mt-[0.5rem] me-2" href="/categories/infrastructure/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Infrastructure
  </span>
</span>

              </a>
            
              <a class="relative mt-[0.5rem] me-2" href="/categories/kubernetes/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Kubernetes
  </span>
</span>

              </a>
            
          
        
      
        
      
        
          
            
              <a class="relative mt-[0.5rem] me-2" href="/tags/k3s/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    K3s
  </span>
</span>

              </a>
            
              <a class="relative mt-[0.5rem] me-2" href="/tags/longhorn/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Longhorn
  </span>
</span>

              </a>
            
              <a class="relative mt-[0.5rem] me-2" href="/tags/argocd/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Argocd
  </span>
</span>

              </a>
            
              <a class="relative mt-[0.5rem] me-2" href="/tags/ansible/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Ansible
  </span>
</span>

              </a>
            
              <a class="relative mt-[0.5rem] me-2" href="/tags/recovery/">
                <span class="flex cursor-pointer">
  <span
    class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Recovery
  </span>
</span>

              </a>
            
          
        
      
    </div>
  

  
  



      </div>
      
    </header>

    
    <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
      
      
      
      
      
        <div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky lg:top-10">
            <details
  open
  id="TOCView"
  class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Inhaltsverzeichnis
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#executive-summary"><strong>Executive Summary</strong></a></li>
    <li><a href="#1-einleitung-die-notwendigkeit-deterministischer-shutdown-prozeduren"><strong>1. Einleitung: Die Notwendigkeit deterministischer Shutdown-Prozeduren</strong></a>
      <ul>
        <li><a href="#11-das-problem-der-persistenz-in-verteilten-systemen"><strong>1.1 Das Problem der Persistenz in verteilten Systemen</strong></a></li>
        <li><a href="#12-der-gitops-konflikt"><strong>1.2 Der GitOps-Konflikt</strong></a></li>
      </ul>
    </li>
    <li><a href="#2-architektur-analyse-und-abhängigkeitsgraph"><strong>2. Architektur-Analyse und Abhängigkeitsgraph</strong></a>
      <ul>
        <li><a href="#21-die-k3s-control-plane-und-agent-topologie"><strong>2.1 Die k3s Control Plane und Agent Topologie</strong></a></li>
        <li><a href="#22-longhorn-distributed-storage-mechanik"><strong>2.2 Longhorn Distributed Storage Mechanik</strong></a></li>
        <li><a href="#23-argocd-reconciliation-loops"><strong>2.3 ArgoCD Reconciliation Loops</strong></a></li>
      </ul>
    </li>
    <li><a href="#3-strategische-planung-des-shutdown-protokolls"><strong>3. Strategische Planung des Shutdown-Protokolls</strong></a>
      <ul>
        <li><a href="#phase-1-globale-gitops-suspension"><strong>Phase 1: Globale GitOps-Suspension</strong></a></li>
        <li><a href="#phase-2-applikations-dekommissionierung-workload-draining"><strong>Phase 2: Applikations-Dekommissionierung (Workload Draining)</strong></a></li>
        <li><a href="#phase-3-verifikation-der-speicher-detachment-abtrennung"><strong>Phase 3: Verifikation der Speicher-Detachment (Abtrennung)</strong></a></li>
        <li><a href="#phase-4-infrastruktur-shutdown"><strong>Phase 4: Infrastruktur-Shutdown</strong></a></li>
      </ul>
    </li>
    <li><a href="#4-automatisierung-via-ansible"><strong>4. Automatisierung via Ansible</strong></a>
      <ul>
        <li><a href="#voraussetzungen"><strong>Voraussetzungen</strong></a></li>
        <li><a href="#das-shutdown-playbook-shutdown_clusteryml"><strong>Das Shutdown-Playbook (shutdown_cluster.yml)</strong></a></li>
      </ul>
    </li>
    <li><a href="#5-das-recovery-protokoll-wiederanfahren"><strong>5. Das Recovery-Protokoll (Wiederanfahren)</strong></a>
      <ul>
        <li><a href="#das-startup-playbook-startup_clusteryml"><strong>Das Startup-Playbook (startup_cluster.yml)</strong></a></li>
      </ul>
    </li>
    <li><a href="#6-deep-dive-fehleranalyse-und-edge-cases"><strong>6. Deep Dive: Fehleranalyse und Edge Cases</strong></a>
      <ul>
        <li><a href="#blockierende-finalizers-auf-pvcs"><strong>Blockierende Finalizers auf PVCs</strong></a></li>
        <li><a href="#die"><strong>Die “ArgoCD Fighting Back” Race Condition</strong></a></li>
      </ul>
    </li>
    <li><a href="#7-fazit"><strong>7. Fazit</strong></a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Inhaltsverzeichnis
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#executive-summary"><strong>Executive Summary</strong></a></li>
    <li><a href="#1-einleitung-die-notwendigkeit-deterministischer-shutdown-prozeduren"><strong>1. Einleitung: Die Notwendigkeit deterministischer Shutdown-Prozeduren</strong></a>
      <ul>
        <li><a href="#11-das-problem-der-persistenz-in-verteilten-systemen"><strong>1.1 Das Problem der Persistenz in verteilten Systemen</strong></a></li>
        <li><a href="#12-der-gitops-konflikt"><strong>1.2 Der GitOps-Konflikt</strong></a></li>
      </ul>
    </li>
    <li><a href="#2-architektur-analyse-und-abhängigkeitsgraph"><strong>2. Architektur-Analyse und Abhängigkeitsgraph</strong></a>
      <ul>
        <li><a href="#21-die-k3s-control-plane-und-agent-topologie"><strong>2.1 Die k3s Control Plane und Agent Topologie</strong></a></li>
        <li><a href="#22-longhorn-distributed-storage-mechanik"><strong>2.2 Longhorn Distributed Storage Mechanik</strong></a></li>
        <li><a href="#23-argocd-reconciliation-loops"><strong>2.3 ArgoCD Reconciliation Loops</strong></a></li>
      </ul>
    </li>
    <li><a href="#3-strategische-planung-des-shutdown-protokolls"><strong>3. Strategische Planung des Shutdown-Protokolls</strong></a>
      <ul>
        <li><a href="#phase-1-globale-gitops-suspension"><strong>Phase 1: Globale GitOps-Suspension</strong></a></li>
        <li><a href="#phase-2-applikations-dekommissionierung-workload-draining"><strong>Phase 2: Applikations-Dekommissionierung (Workload Draining)</strong></a></li>
        <li><a href="#phase-3-verifikation-der-speicher-detachment-abtrennung"><strong>Phase 3: Verifikation der Speicher-Detachment (Abtrennung)</strong></a></li>
        <li><a href="#phase-4-infrastruktur-shutdown"><strong>Phase 4: Infrastruktur-Shutdown</strong></a></li>
      </ul>
    </li>
    <li><a href="#4-automatisierung-via-ansible"><strong>4. Automatisierung via Ansible</strong></a>
      <ul>
        <li><a href="#voraussetzungen"><strong>Voraussetzungen</strong></a></li>
        <li><a href="#das-shutdown-playbook-shutdown_clusteryml"><strong>Das Shutdown-Playbook (shutdown_cluster.yml)</strong></a></li>
      </ul>
    </li>
    <li><a href="#5-das-recovery-protokoll-wiederanfahren"><strong>5. Das Recovery-Protokoll (Wiederanfahren)</strong></a>
      <ul>
        <li><a href="#das-startup-playbook-startup_clusteryml"><strong>Das Startup-Playbook (startup_cluster.yml)</strong></a></li>
      </ul>
    </li>
    <li><a href="#6-deep-dive-fehleranalyse-und-edge-cases"><strong>6. Deep Dive: Fehleranalyse und Edge Cases</strong></a>
      <ul>
        <li><a href="#blockierende-finalizers-auf-pvcs"><strong>Blockierende Finalizers auf PVCs</strong></a></li>
        <li><a href="#die"><strong>Die “ArgoCD Fighting Back” Race Condition</strong></a></li>
      </ul>
    </li>
    <li><a href="#7-fazit"><strong>7. Fazit</strong></a></li>
  </ul>
</nav>
  </div>
</details>


<script>
  (function () {
    'use strict'

    const SCROLL_OFFSET_RATIO = 0.33
    const TOC_SELECTOR = '#TableOfContents'
    const ANCHOR_SELECTOR = '.anchor'
    const TOC_LINK_SELECTOR = 'a[href^="#"]'
    const NESTED_LIST_SELECTOR = 'li ul'
    const ACTIVE_CLASS = 'active'
    let isJumpingToAnchor = false

    function getActiveAnchorId(anchors, offsetRatio) {
      const threshold = window.scrollY + window.innerHeight * offsetRatio
      const tocLinks = [...document.querySelectorAll('#TableOfContents a[href^="#"]')]
      const tocIds = new Set(tocLinks.map(link => link.getAttribute('href').substring(1)))

      if (isJumpingToAnchor) {
        for (let i = 0; i < anchors.length; i++) {
          const anchor = anchors[i]
          if (!tocIds.has(anchor.id)) continue
          const top = anchor.getBoundingClientRect().top + window.scrollY
          if (Math.abs(window.scrollY - top) < 100) {
            return anchor.id
          }
        }
      }

      for (let i = anchors.length - 1; i >= 0; i--) {
        const top = anchors[i].getBoundingClientRect().top + window.scrollY
        if (top <= threshold && tocIds.has(anchors[i].id)) {
          return anchors[i].id
        }
      }
      return anchors.find(anchor => tocIds.has(anchor.id))?.id || ''
    }

    function updateTOC({ toc, anchors, links, scrollOffset, collapseInactive }) {
      const activeId = getActiveAnchorId(anchors, scrollOffset)
      if (!activeId) return

      links.forEach(link => {
        const isActive = link.getAttribute('href') === `#${activeId}`
        link.classList.toggle(ACTIVE_CLASS, isActive)

        if (collapseInactive) {
          const ul = link.closest('li')?.querySelector('ul')
          if (ul) ul.style.display = isActive ? '' : 'none'
        }
      })

      if (collapseInactive) {
        const activeLink = toc.querySelector(`a[href="#${CSS.escape(activeId)}"]`)
        let el = activeLink
        while (el && el !== toc) {
          if (el.tagName === 'UL') el.style.display = ''
          if (el.tagName === 'LI') el.querySelector('ul')?.style.setProperty('display', '')
          el = el.parentElement
        }
      }
    }

    function initTOC() {
      const toc = document.querySelector(TOC_SELECTOR)
      if (!toc) return

      const collapseInactive = false
      const anchors = [...document.querySelectorAll(ANCHOR_SELECTOR)]
      const links = [...toc.querySelectorAll(TOC_LINK_SELECTOR)]

      if (collapseInactive) {
        toc.querySelectorAll(NESTED_LIST_SELECTOR).forEach(ul => ul.style.display = 'none')
      }

      links.forEach(link => {
        link.addEventListener('click', () => {
          isJumpingToAnchor = true
        })
      })

      const config = {
        toc,
        anchors,
        links,
        scrollOffset: SCROLL_OFFSET_RATIO,
        collapseInactive
      }

      window.addEventListener('scroll', () => updateTOC(config), { passive: true })
      window.addEventListener('hashchange', () => updateTOC(config), { passive: true })

      updateTOC(config)
    }

    document.readyState === 'loading'
      ? document.addEventListener('DOMContentLoaded', initTOC)
      : initTOC()
  })()
</script>


          </div>
        </div>
      


      <div class="min-w-0 min-h-0 max-w-fit">
        

        <div class="article-content max-w-prose mb-20">
          
<h2 class="relative group"><strong>Executive Summary</strong>
    <div id="executive-summary" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#executive-summary" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Der Betrieb von Kubernetes-Clustern, die stateful Workloads (zustandsbehaftete Anwendungen) beherbergen, erfordert rigorose Protokolle für das
Lebenszyklusmanagement. Im Gegensatz zu stateless Umgebungen, in denen Nodes als ephemere Ressourcen behandelt werden können, verlangen Cluster, die auf
verteiltem Blockspeicher basieren - im Speziellen Longhorn -, eine präzise Orchestrierung während der Shutdown-Prozeduren, um Datenkorruption und Inkonsistenzen
auf Volume-Ebene zu verhindern. Zusätzlich führt die Integration von GitOps-Prinzipien durch ArgoCD eine weitere Komplexitätsebene ein: Die Reconciliation-Loops
(Abgleichschleifen) müssen kontrolliert ausgesetzt werden, um eine automatisierte, ungewollte Wiederherstellung von Diensten während kritischer Wartungsfenster
zu unterbinden.  Dieser Artikel liefert eine technische Analyse und einen prozeduralen Leitfaden für das geordnete Herunterfahren und Wiederanfahren eines
Kubernetes-Clusters, der auf dem Stack k3s, Longhorn und ArgoCD basiert.</p>

<h2 class="relative group"><strong>1. Einleitung: Die Notwendigkeit deterministischer Shutdown-Prozeduren</strong>
    <div id="1-einleitung-die-notwendigkeit-deterministischer-shutdown-prozeduren" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#1-einleitung-die-notwendigkeit-deterministischer-shutdown-prozeduren" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>In der modernen Container-Orchestrierung wird oft angenommen, dass Systeme resilient gegen plötzliche Ausfälle sind. Während Kubernetes hervorragende
Mechanismen zur Selbstheilung bietet, gilt dies primär für den Ausfall einzelner Komponenten in einem hochverfügbaren Verbund. Der komplette Shutdown eines
Clusters - etwa für Stromwartungen, Rechenzentrumsumzüge oder Hardware-Upgrades - stellt jedoch ein fundamental anderes Szenario dar. Hierbei werden alle
Redundanzebenen gleichzeitig entfernt.</p>

<h3 class="relative group"><strong>1.1 Das Problem der Persistenz in verteilten Systemen</strong>
    <div id="11-das-problem-der-persistenz-in-verteilten-systemen" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#11-das-problem-der-persistenz-in-verteilten-systemen" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Bei der Verwendung von Local-Storage oder verteilten Speichersystemen wie Longhorn liegt die Datenhoheit nicht bei einem externen SAN, sondern direkt auf den Compute-Nodes. Ein unkontrolliertes Ausschalten (&ldquo;Hard Power-off&rdquo;) eines Nodes, während ein Longhorn-Volume noch als Attached markiert ist, führt unweigerlich zu &ldquo;Stale Handles&rdquo; in der Metadaten-Datenbank (etcd). Das System glaubt beim Neustart, das Volume sei noch auf dem alten Node gemountet, und verhindert aus Sicherheitsgründen (RWO - ReadWriteOnce Schutz) das erneute Mounten. Dies führt zu langen Ausfallzeiten, die manuelle Eingriffe in die Custom Resource Definitions (CRDs) erfordern.</p>

<h3 class="relative group"><strong>1.2 Der GitOps-Konflikt</strong>
    <div id="12-der-gitops-konflikt" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#12-der-gitops-konflikt" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>ArgoCD fungiert als autonomer Agent, der den Cluster-Zustand permanent gegen ein Git-Repository prüft. In einem Wartungsszenario, bei dem ein Administrator
Workloads herunterfährt (skaliert auf 0), interpretiert ArgoCD dies als &ldquo;Configuration Drift&rdquo; - eine Abweichung vom Soll-Zustand. Ist &ldquo;Self-Heal&rdquo; aktiviert,
wird ArgoCD sofort versuchen, die Workloads wieder zu starten. Dies erzeugt eine Race Condition zwischen dem Shutdown-Skript und dem GitOps-Controller.</p>

<h2 class="relative group"><strong>2. Architektur-Analyse und Abhängigkeitsgraph</strong>
    <div id="2-architektur-analyse-und-abhängigkeitsgraph" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#2-architektur-analyse-und-abh%c3%a4ngigkeitsgraph" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Um ein robustes Protokoll zu entwickeln, muss zunächst das Zusammenspiel der drei Kernkomponenten verstanden werden: Der Orchestrator (k3s), die Storage-Engine (Longhorn) und der Continuous-Delivery-Controller (ArgoCD).</p>

<h3 class="relative group"><strong>2.1 Die k3s Control Plane und Agent Topologie</strong>
    <div id="21-die-k3s-control-plane-und-agent-topologie" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#21-die-k3s-control-plane-und-agent-topologie" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>k3s operiert als konsolidierte Kubernetes-Distribution. In einer typischen Deployment-Struktur ist die Service-Architektur in den k3s-server (Control Plane und API Server) und den k3s-agent (Worker Node) unterteilt.</p>
<ul>
<li><strong>Prozess-Lebenszyklus:</strong> Der Shutdown ist kritisch, da das Kubelet für die geordnete Beendigung von Pods verantwortlich ist. Sendet das Betriebssystem ein SIGKILL an den k3s-Prozess, bevor das Kubelet Zeit hatte, Container-Pre-Stop-Hooks auszuführen, werden Datenbank-Buffer nicht auf die Disk geflusht.</li>
<li><strong>Systemd Integration:</strong> Ein systemctl stop k3s triggert zwar das Beenden der Kubernetes-Dienste, garantiert aber nicht, dass alle von containerd verwalteten Container sauber beendet wurden.</li>
</ul>

<h3 class="relative group"><strong>2.2 Longhorn Distributed Storage Mechanik</strong>
    <div id="22-longhorn-distributed-storage-mechanik" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#22-longhorn-distributed-storage-mechanik" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Longhorn operiert als Microservices-basiertes verteiltes Blockspeichersystem.</p>
<ul>
<li><strong>Risiko des unsauberen Shutdowns:</strong> Wird ein Node ausgeschaltet, während ein Longhorn-Volume noch verbunden (attached) ist, hat die Engine keine Zeit, die Verbindung sauber zu schließen. In der etcd-Datenbank verbleibt das Volume im Status Attached oder Faulted.</li>
<li><strong>RWO Restriktion:</strong> Die meisten Longhorn-Volumes sind ReadWriteOnce (RWO). Wenn der Cluster nicht sauber heruntergefahren wird, bleibt der Lock auf dem Volume bestehen.</li>
</ul>

<h3 class="relative group"><strong>2.3 ArgoCD Reconciliation Loops</strong>
    <div id="23-argocd-reconciliation-loops" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#23-argocd-reconciliation-loops" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>ArgoCD erzwingt den im Git definierten Zustand.</p>
<ul>
<li><strong>Konfliktpotenzial:</strong> Wenn ein Administrator manuell Deployments herunterskaliert, um Longhorn-Volumes freizugeben, erkennt ArgoCD dies als &ldquo;Out of Sync&rdquo;.</li>
<li><strong>Lösung:</strong> Der erste Schritt jedes Wartungsprotokolls muss die globale Suspension des Reconciliation-Loops sein.</li>
</ul>

<h2 class="relative group"><strong>3. Strategische Planung des Shutdown-Protokolls</strong>
    <div id="3-strategische-planung-des-shutdown-protokolls" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#3-strategische-planung-des-shutdown-protokolls" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Das Shutdown-Prozedere wird durch eine strikte Abhängigkeitskette definiert.</p>

<h3 class="relative group"><strong>Phase 1: Globale GitOps-Suspension</strong>
    <div id="phase-1-globale-gitops-suspension" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#phase-1-globale-gitops-suspension" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Wir nutzen das Skalieren des argocd-application-controller StatefulSets auf Null. Dies &ldquo;friert&rdquo; den Cluster-Zustand effektiv ein und garantiert, dass keine Hintergrundprozesse versuchen, Ressourcen zu modifizieren.</p>

<h3 class="relative group"><strong>Phase 2: Applikations-Dekommissionierung (Workload Draining)</strong>
    <div id="phase-2-applikations-dekommissionierung-workload-draining" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#phase-2-applikations-dekommissionierung-workload-draining" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Ist ArgoCD pausiert, müssen zustandsbehaftete Workloads auf Null skaliert werden. Dies fungiert als Trigger für das Container Storage Interface (CSI), um ControllerUnpublishVolume-Aufrufe an Longhorn zu senden.</p>
<ul>
<li><strong>Identifikation:</strong> Wir stoppen alle Deployments und StatefulSets in User-Namespaces.</li>
<li><strong>Verifikation:</strong> Ein Pod im Status Terminating kann immer noch einen Lock auf ein Longhorn-Volume halten.</li>
</ul>

<h3 class="relative group"><strong>Phase 3: Verifikation der Speicher-Detachment (Abtrennung)</strong>
    <div id="phase-3-verifikation-der-speicher-detachment-abtrennung" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#phase-3-verifikation-der-speicher-detachment-abtrennung" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Dies ist der wichtigste Sicherheitscheck. Die Longhorn API muss abgefragt werden. Wenn irgendein Volume status.state: attached meldet, muss der Node-Shutdown abgebrochen werden.</p>
<ul>
<li><strong>Wichtig:</strong> Longhorn-Systemkomponenten (Manager, Driver) müssen weiterlaufen, bis alle User-Volumes abgetrennt sind.</li>
</ul>

<h3 class="relative group"><strong>Phase 4: Infrastruktur-Shutdown</strong>
    <div id="phase-4-infrastruktur-shutdown" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#phase-4-infrastruktur-shutdown" aria-label="Anker">#</a>
    </span>
    
</h3>
<ol>
<li><strong>Stop Agents:</strong> Verhindert neues Scheduling.</li>
<li><strong>Stop Server:</strong> Terminiert die Control Plane.</li>
<li><strong>OS Shutdown:</strong> shutdown -h now.</li>
</ol>

<h2 class="relative group"><strong>4. Automatisierung via Ansible</strong>
    <div id="4-automatisierung-via-ansible" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#4-automatisierung-via-ansible" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Die manuelle Ausführung ist fehleranfällig. Nachfolgend die Ansible-Implementierung.</p>

<h3 class="relative group"><strong>Voraussetzungen</strong>
    <div id="voraussetzungen" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#voraussetzungen" aria-label="Anker">#</a>
    </span>
    
</h3>
<ul>
<li>Ansible Core + kubernetes.core Collection.</li>
<li>Python-Libraries: kubernetes, jsonpatch, PyYAML.</li>
<li>Gültige kubeconfig.</li>
</ul>

<h3 class="relative group"><strong>Das Shutdown-Playbook (shutdown_cluster.yml)</strong>
    <div id="das-shutdown-playbook-shutdown_clusteryml" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#das-shutdown-playbook-shutdown_clusteryml" aria-label="Anker">#</a>
    </span>
    
</h3>


  




  






  
  
  






  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="ln">  1</span><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Graceful</span> <span class="n">Cluster</span> <span class="n">Shutdown</span> <span class="n">Protocol</span> <span class="p">(</span><span class="n">Geordnetes</span> <span class="n">Herunterfahren</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl">  <span class="n">hosts</span><span class="p">:</span> <span class="n">localhost</span>
</span></span><span class="line"><span class="ln">  4</span><span class="cl">  <span class="n">connection</span><span class="p">:</span> <span class="n">local</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl">  <span class="n">gather_facts</span><span class="p">:</span> <span class="bp">false</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl">  <span class="n">vars</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl">    <span class="c1"># Pfad zur Kubeconfig - Anpassen falls notwendig</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl">    <span class="n">kubeconfig_path</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">fabrice</span><span class="o">/.</span><span class="n">kube</span><span class="o">/</span><span class="n">prod</span><span class="o">.</span><span class="n">zyria</span><span class="o">.</span><span class="n">de</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl">    <span class="n">longhorn_ns</span><span class="p">:</span> <span class="s2">&#34;longhorn-system&#34;</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">    <span class="n">argocd_ns</span><span class="p">:</span> <span class="s2">&#34;argocd&#34;</span>
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">    <span class="n">detachment_timeout</span><span class="p">:</span> <span class="mi">300</span>
</span></span><span class="line"><span class="ln"> 12</span><span class="cl">
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">  <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="c1"># Phase 1: ArgoCD Reconciliation Suspendieren</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Prüfe</span> <span class="n">Status</span> <span class="n">des</span> <span class="n">ArgoCD</span> <span class="n">Application</span> <span class="n">Controllers</span>
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_info</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ argocd_ns }}&#34;</span>
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">argocd</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">controller</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">      <span class="n">register</span><span class="p">:</span> <span class="n">argocd_controller_state</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Skaliere</span> <span class="n">ArgoCD</span> <span class="n">Application</span> <span class="n">Controller</span> <span class="n">auf</span> <span class="mi">0</span> <span class="p">(</span><span class="n">Pause</span> <span class="n">Reconciliation</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">        <span class="n">api_version</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">argocd</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">controller</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ argocd_ns }}&#34;</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">        <span class="n">replicas</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">        <span class="n">wait</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">      <span class="n">when</span><span class="p">:</span> <span class="n">argocd_controller_state</span><span class="o">.</span><span class="n">resources</span> <span class="o">|</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">      <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">argocd</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">    <span class="c1"># Phase 2: Skalieren der Stateful Workloads</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Hole</span> <span class="n">alle</span> <span class="n">Deployments</span> <span class="n">im</span> <span class="n">Cluster</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_info</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">      <span class="n">register</span><span class="p">:</span> <span class="n">all_deployments</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Hole</span> <span class="n">alle</span> <span class="n">StatefulSets</span> <span class="n">im</span> <span class="n">Cluster</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_info</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">      <span class="n">register</span><span class="p">:</span> <span class="n">all_statefulsets</span>
</span></span><span class="line"><span class="ln"> 51</span><span class="cl">
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Skaliere</span> <span class="n">alle</span> <span class="n">User</span><span class="o">-</span><span class="n">Deployments</span> <span class="n">auf</span> <span class="mi">0</span> <span class="n">herunter</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">        <span class="n">api_version</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.name }}&#34;</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.namespace }}&#34;</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">        <span class="n">replicas</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">        <span class="n">wait</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">      <span class="n">loop</span><span class="p">:</span> <span class="s2">&#34;{{ all_deployments.resources }}&#34;</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">      <span class="n">loop_control</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">        <span class="n">label</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.namespace }}/{{ item.metadata.name }}&#34;</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">      <span class="n">when</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">        <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kube-system&#39;</span><span class="p">,</span> <span class="s1">&#39;longhorn-system&#39;</span><span class="p">,</span> <span class="s1">&#39;argocd&#39;</span><span class="p">,</span> <span class="s1">&#39;monitoring&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">        <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">replicas</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">      <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">      <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">workloads</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Skaliere</span> <span class="n">alle</span> <span class="n">User</span><span class="o">-</span><span class="n">StatefulSets</span> <span class="n">auf</span> <span class="mi">0</span> <span class="n">herunter</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">        <span class="n">api_version</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.name }}&#34;</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.namespace }}&#34;</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">        <span class="n">replicas</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">        <span class="n">wait</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">      <span class="n">loop</span><span class="p">:</span> <span class="s2">&#34;{{ all_statefulsets.resources }}&#34;</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">      <span class="n">loop_control</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">        <span class="n">label</span><span class="p">:</span> <span class="s2">&#34;{{ item.metadata.namespace }}/{{ item.metadata.name }}&#34;</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl">      <span class="n">when</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">        <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">namespace</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kube-system&#39;</span><span class="p">,</span> <span class="s1">&#39;longhorn-system&#39;</span><span class="p">,</span> <span class="s1">&#39;argocd&#39;</span><span class="p">,</span> <span class="s1">&#39;monitoring&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 84</span><span class="cl">        <span class="o">-</span> <span class="n">item</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">replicas</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl">      <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">workloads</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl">
</span></span><span class="line"><span class="ln"> 87</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">    <span class="c1"># Phase 3: Verifikation des Longhorn Volume Detachments</span>
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="c1">#    - name: Warte darauf, dass alle Longhorn Volumes den Status &#39;detached&#39; haben</span>
</span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="c1">#      kubernetes.core.k8s_info:</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="c1">#        kubeconfig: &#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="c1">#        api_version: longhorn.io/v1beta2</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="c1">#        kind: Volume</span>
</span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="c1">#        namespace: &#34;{{ longhorn_ns }}&#34;</span>
</span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="c1">#      register: longhorn_volumes</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="c1">#      until: &#34;longhorn_volumes.resources | json_query(&#39;[?status.state!=\\&#39;detached\\&#39;]&#39;) | length == 0&#34;</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="c1">#      retries: &#34;{{ (detachment_timeout / 10) | int }}&#34;</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="c1">#      delay: 10</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="c1">#      tags: [storage]</span>
</span></span><span class="line"><span class="ln">101</span><span class="cl">
</span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="c1"># Phase 4: Stop k3s Services auf den physischen Nodes</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Stop</span> <span class="n">k3s</span> <span class="n">Services</span> <span class="n">und</span> <span class="n">Shutdown</span> <span class="n">Nodes</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">  <span class="n">hosts</span><span class="p">:</span> <span class="n">all</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">  <span class="n">become</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">  <span class="n">gather_facts</span><span class="p">:</span> <span class="bp">false</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">  <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">infrastructure</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">  <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Stoppe</span> <span class="n">k3s</span><span class="o">-</span><span class="n">agent</span> <span class="p">(</span><span class="n">Worker</span> <span class="n">Nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">      <span class="n">ansible</span><span class="o">.</span><span class="n">builtin</span><span class="o">.</span><span class="n">systemd</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">k3s</span><span class="o">-</span><span class="n">agent</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl">        <span class="n">state</span><span class="p">:</span> <span class="n">stopped</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">      <span class="n">when</span><span class="p">:</span> <span class="s2">&#34;&#39;k3s_agent&#39; in group_names&#34;</span>
</span></span><span class="line"><span class="ln">116</span><span class="cl">      <span class="n">ignore_errors</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">
</span></span><span class="line"><span class="ln">118</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Stoppe</span> <span class="n">k3s</span> <span class="p">(</span><span class="n">Server</span><span class="o">/</span><span class="n">Master</span> <span class="n">Nodes</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">      <span class="n">ansible</span><span class="o">.</span><span class="n">builtin</span><span class="o">.</span><span class="n">systemd</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">k3s</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">        <span class="n">state</span><span class="p">:</span> <span class="n">stopped</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">      <span class="n">when</span><span class="p">:</span> <span class="s2">&#34;&#39;k3s_server&#39; in group_names&#34;</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">
</span></span><span class="line"><span class="ln">124</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Shutdown</span> <span class="n">Operating</span> <span class="n">System</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">      <span class="n">community</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">shutdown</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">        <span class="n">delay</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">        <span class="n">msg</span><span class="p">:</span> <span class="s2">&#34;Automatischer Shutdown durch Ansible Playbook&#34;</span>
</span></span></code></pre></div>



<h2 class="relative group"><strong>5. Das Recovery-Protokoll (Wiederanfahren)</strong>
    <div id="5-das-recovery-protokoll-wiederanfahren" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#5-das-recovery-protokoll-wiederanfahren" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Das Starten des Clusters erfordert die Umkehrung der Reihenfolge. Das Speichersystem muss gesund sein, bevor die Anwendungen hochskaliert werden.</p>

<h3 class="relative group"><strong>Das Startup-Playbook (startup_cluster.yml)</strong>
    <div id="das-startup-playbook-startup_clusteryml" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#das-startup-playbook-startup_clusteryml" aria-label="Anker">#</a>
    </span>
    
</h3>


  




  






  
  
  






  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1"># - name: Graceful Cluster Startup Protocol (Startvorgang)</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1">#   hosts: all</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="c1">#   become: true</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1">#   tags: [infrastructure]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1">#   tasks:</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1">#     # ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="c1">#     # Phase 1: Nodes Booten und k3s Starten</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1">#     # ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">#     # Voraussetzung: Nodes sind via Wake-on-LAN oder physisch gestartet</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1">#     - name: Starte k3s (Server/Master)</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1">#       ansible.builtin.systemd:</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="c1">#         name: k3s</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">#         state: started</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1">#         enabled: true</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1">#       when: &#34;&#39;k3s_server&#39; in group_names&#34;</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="c1">#     - name: Starte k3s-agent (Worker)</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="c1">#       ansible.builtin.systemd:</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="c1">#         name: k3s-agent</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="c1">#         state: started</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="c1">#         enabled: true</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1">#       when: &#34;&#39;k3s_agent&#39; in group_names&#34;</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Orchestrate</span> <span class="n">Workload</span> <span class="n">Recovery</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">  <span class="n">hosts</span><span class="p">:</span> <span class="n">localhost</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">  <span class="n">connection</span><span class="p">:</span> <span class="n">local</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">  <span class="n">gather_facts</span><span class="p">:</span> <span class="bp">false</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">  <span class="n">vars</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="n">kubeconfig_path</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">fabrice</span><span class="o">/.</span><span class="n">kube</span><span class="o">/</span><span class="n">prod</span><span class="o">.</span><span class="n">zyria</span><span class="o">.</span><span class="n">de</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="n">longhorn_ns</span><span class="p">:</span> <span class="s2">&#34;longhorn-system&#34;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">    <span class="n">argocd_ns</span><span class="p">:</span> <span class="s2">&#34;argocd&#34;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">  <span class="n">tasks</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">    <span class="c1"># Phase 2: Verifikation der Storage-Gesundheit</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Warte</span> <span class="n">bis</span> <span class="n">Longhorn</span> <span class="n">Nodes</span> <span class="s1">&#39;Ready&#39;</span> <span class="n">sind</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_info</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">api_version</span><span class="p">:</span> <span class="n">longhorn</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta2</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="ne">Node</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ longhorn_ns }}&#34;</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">      <span class="n">register</span><span class="p">:</span> <span class="n">lh_nodes</span>
</span></span><span class="line"><span class="ln">46</span><span class="cl">      <span class="n">until</span><span class="p">:</span> <span class="n">lh_nodes</span><span class="o">.</span><span class="n">resources</span> <span class="o">|</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">      <span class="n">retries</span><span class="p">:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">      <span class="n">delay</span><span class="p">:</span> <span class="mi">10</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">      <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">storage</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">
</span></span><span class="line"><span class="ln">51</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Warte</span> <span class="n">auf</span> <span class="n">Longhorn</span> <span class="n">System</span> <span class="n">Pods</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_info</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ longhorn_ns }}&#34;</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl">        <span class="n">field_selectors</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">          <span class="o">-</span> <span class="n">status</span><span class="o">.</span><span class="n">phase</span><span class="o">=</span><span class="n">Running</span>
</span></span><span class="line"><span class="ln">58</span><span class="cl">      <span class="n">register</span><span class="p">:</span> <span class="n">lh_pods</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">      <span class="n">until</span><span class="p">:</span> <span class="n">lh_pods</span><span class="o">.</span><span class="n">resources</span> <span class="o">|</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">      <span class="n">retries</span><span class="p">:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">      <span class="n">delay</span><span class="p">:</span> <span class="mi">10</span>
</span></span><span class="line"><span class="ln">62</span><span class="cl">
</span></span><span class="line"><span class="ln">63</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">    <span class="c1"># Phase 3: ArgoCD Reaktivierung</span>
</span></span><span class="line"><span class="ln">65</span><span class="cl">    <span class="c1"># ---------------------------------------------------------</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">    <span class="c1"># Durch das Hochskalieren erkennt ArgoCD den Drift (0 vs 1 im Git)</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">    <span class="c1"># und stellt die Applikationen automatisch wieder her.</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">
</span></span><span class="line"><span class="ln">69</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Skaliere</span> <span class="n">ArgoCD</span> <span class="n">Application</span> <span class="n">Controller</span> <span class="n">auf</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">      <span class="n">kubernetes</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">k8s_scale</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">71</span><span class="cl">        <span class="n">kubeconfig</span><span class="p">:</span> <span class="s2">&#34;{{ kubeconfig_path }}&#34;</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">        <span class="n">api_version</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span></span><span class="line"><span class="ln">73</span><span class="cl">        <span class="n">kind</span><span class="p">:</span> <span class="n">StatefulSet</span>
</span></span><span class="line"><span class="ln">74</span><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">argocd</span><span class="o">-</span><span class="n">application</span><span class="o">-</span><span class="n">controller</span>
</span></span><span class="line"><span class="ln">75</span><span class="cl">        <span class="n">namespace</span><span class="p">:</span> <span class="s2">&#34;{{ argocd_ns }}&#34;</span>
</span></span><span class="line"><span class="ln">76</span><span class="cl">        <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="ln">77</span><span class="cl">        <span class="n">wait</span><span class="p">:</span> <span class="bp">true</span>
</span></span><span class="line"><span class="ln">78</span><span class="cl">      <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="n">argocd</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">79</span><span class="cl">
</span></span><span class="line"><span class="ln">80</span><span class="cl">    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Warte</span> <span class="n">auf</span> <span class="n">ArgoCD</span> <span class="n">Reconciliation</span>
</span></span><span class="line"><span class="ln">81</span><span class="cl">      <span class="n">ansible</span><span class="o">.</span><span class="n">builtin</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">82</span><span class="cl">        <span class="n">msg</span><span class="p">:</span> <span class="s2">&#34;ArgoCD Controller neugestartet. Auto-Sync wird nun initiiert.&#34;</span>
</span></span></code></pre></div>



<h2 class="relative group"><strong>6. Deep Dive: Fehleranalyse und Edge Cases</strong>
    <div id="6-deep-dive-fehleranalyse-und-edge-cases" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#6-deep-dive-fehleranalyse-und-edge-cases" aria-label="Anker">#</a>
    </span>
    
</h2>

<h3 class="relative group"><strong>Blockierende Finalizers auf PVCs</strong>
    <div id="blockierende-finalizers-auf-pvcs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#blockierende-finalizers-auf-pvcs" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Ein häufiges Problem beim Shutdown ist, dass Ressourcen im Status Terminating hängen bleiben. Ein Pod im Status Terminating kann immer noch einen Lock auf ein Longhorn-Volume halten. Das Ansible Playbook verlässt sich darauf, dass k8s_scale den Controller zwingt, die Pods zu entfernen. Reagiert das Kubelet auf einem Node nicht, bleibt das Pod-Objekt bestehen.</p>

<h3 class="relative group"><strong>Die &ldquo;ArgoCD Fighting Back&rdquo; Race Condition</strong>
    <div id="die" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#die" aria-label="Anker">#</a>
    </span>
    
</h3>
<p>Wird der argocd-application-controller nicht auf 0 skaliert <em>bevor</em> die Anwendungen heruntergefahren werden, entsteht eine Race Condition:</p>
<ol>
<li>Ansible skaliert deployment/my-app auf 0.</li>
<li>ArgoCD erkennt Drift (Live: 0, Git: 1) und patched zurück auf 1.</li>
<li>Longhorn versucht, das Volume neu zu attachen, während Ansible den Node herunterfährt.</li>
<li><strong>Resultat:</strong> Volume-Korruption.</li>
</ol>

<h2 class="relative group"><strong>7. Fazit</strong>
    <div id="7-fazit" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none">
        <a class="text-primary-300 dark:text-neutral-700 !no-underline" href="#7-fazit" aria-label="Anker">#</a>
    </span>
    
</h2>
<p>Das sichere Herunterfahren eines k3s-Clusters mit persistentem Speicher ist fundamental eine Übung im <strong>Abhängigkeitsmanagement</strong>. Die Hierarchie lautet:</p>
<ol>
<li><strong>GitOps Layer (ArgoCD):</strong> Muss zuerst verstummen.</li>
<li><strong>Application Layer:</strong> Muss terminiert werden (Volume Release).</li>
<li><strong>Storage Layer (Longhorn):</strong> Muss Detachment bestätigen.</li>
<li><strong>Infrastruktur Layer (k3s/OS):</strong> Darf erst am Ende ausgeschaltet werden.</li>
</ol>
<p>Durch die Kapselung dieser Logik in Ansible Playbooks wird das Risiko von &ldquo;Split-Brain&rdquo;-Szenarien in der Storage-Engine signifikant reduziert.</p>

          
          
          
            <strong class="block mt-8">
              <a
                target="_blank"
                class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
                href="mailto:fabrice@zyria.de?subject=Reply%20to%20Operational%20Lifecycle%20Management%3a%20Orchestrierter%20Shutdown%20f%c3%bcr%20Kubernetes">
                Per E-Mail antworten
              </a>
            </strong>
          
        </div>
        
          
  
  
  
  
  
  

  

  
    
    
<div class="flex author">
  
    
    
      
    
    
      
      
      
        
        
        
      
      <img
        class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4"
        width="96"
        height="96"
        alt="Fabrice Kirchner"
        src="/images/chibi-head_hu_9d79aad7f39b8429.jpg"
        data-zoom-src="/images/chibi-head_hu_98bedca1f87cedd.jpg">
    
  
  <div class="place-self-center">
    
      <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
        Autor
      </div>
      <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
        Fabrice Kirchner
      </div>
    
    
      <div class="text-sm text-neutral-700 dark:text-neutral-400">stolzer Vater, Nerd, Admin</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:fabrice@zyria.de"
          target="_blank"
          aria-label="Email"
          title="Email"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://git.casa-due-pur.de/fabrice.kirchner"
          target="_blank"
          aria-label="Forgejo"
          title="Forgejo"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 212 212" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke="currentColor"><g style="opacity:.7"><path stroke-width="25" d="M64 174V76a50 50 0 0 1 50-50h20"/><circle stroke-width="15" cx="148" cy="26" r="18"/></g><path stroke-width="25" d="M64 174v-30a50 50 0 0 1 50-50h20"/><circle stroke-width="15" cx="148" cy="94" r="18"/><circle stroke-width="15" cx="64" cy="186" r="18"/></g></svg></span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://git.zyria.de/pyrox"
          target="_blank"
          aria-label="Forgejo"
          title="Forgejo"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 212 212" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke="currentColor"><g style="opacity:.7"><path stroke-width="25" d="M64 174V76a50 50 0 0 1 50-50h20"/><circle stroke-width="15" cx="148" cy="26" r="18"/></g><path stroke-width="25" d="M64 174v-30a50 50 0 0 1 50-50h20"/><circle stroke-width="15" cx="148" cy="94" r="18"/><circle stroke-width="15" cx="64" cy="186" r="18"/></g></svg></span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/ricariel"
          target="_blank"
          aria-label="Github"
          title="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/fabrice-kirchner-bb5408163/"
          target="_blank"
          aria-label="Linkedin"
          title="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.xing.com/profile/Fabrice_Kirchner"
          target="_blank"
          aria-label="Xing"
          title="Xing"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Xing</title><path fill="currentColor" d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></svg></span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://kirchner.social/@fabrice"
          target="_blank"
          aria-label="Mastodon"
          title="Mastodon"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</span></span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://codeberg.org/ricariel"
          target="_blank"
          aria-label="Codeberg"
          title="Codeberg"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom"><span class="relative block icon"><?xml version="1.0" encoding="utf-8"?>
<svg fill="currentColor" viewBox="0 0 24 24" role="img" xmlns="http://www.w3.org/2000/svg"><path d="M11.955.49A12 12 0 0 0 0 12.49a12 12 0 0 0 1.832 6.373L11.838 5.928a.187.14 0 0 1 .324 0l10.006 12.935A12 12 0 0 0 24 12.49a12 12 0 0 0-12-12 12 12 0 0 0-.045 0zm.375 6.467 4.416 16.553a12 12 0 0 0 5.137-4.213z"/></svg>
</span></span></a
        >
      
    
  </div>

</div>
  </div>
</div>

  

  

  
    <div class="mb-10"></div>
  

        
        

        

        

      </div>
    </section>

    
    <footer class="pt-8 max-w-prose print:hidden">
      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600">
      <div class="flex justify-between pt-3">
        <span class="flex flex-col">
          
            <a
              class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
              href="/posts/homelab/k3s-prod/ansible/readme/">
              <span class="leading-6">
                <span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Ansible Konfiguration für k3s-prod
              </span>
            </a>
            
              <span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400">
                <time datetime="2026-02-16T01:12:21&#43;01:00">16 Februar 2026</time>
              </span>
            
          
        </span>
        <span class="flex flex-col items-end">
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

        


  






<div
  id="scroll-to-top"
  class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200">
  <a
    href="#the-top"
    class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Zum Anfang scrollen"
    title="Zum Anfang scrollen">
    &uarr;
  </a>
</div>

      </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
      
      
        
          
          
      
      
      
      <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400 ">
        <ul class="flex list-none flex-col sm:flex-row">
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 ">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href="/datenschutz/"
                title="Datenschutzerklärung">
                
                Datenschutzerklärung
              </a>
            </li>
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 ">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href="/impressum/"
                title="Impressum">
                
                Impressum
              </a>
            </li>
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 ">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href="/sitemap/"
                title="Sitemap">
                
                Sitemap
              </a>
            </li>
          
            <li class=" flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0 ">
              <a
                class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center"
                href="/tags/"
                title="Tags">
                
                Tags
              </a>
            </li>
          
        </ul>
      </nav>
    
  
  <div class="flex items-center justify-between">
    
    

    
    
  </div>
  
    <script>
      mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
        margin: 24,
        background: "rgba(0,0,0,0.5)",
        scrollOffset: 0,
      });
    </script>
  
  
  
      <div class="flex items-center justify-between">
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
    ©
    
      2003 -
    
    2026
     Fabrice Kirchner 
    
      </p>
          <p class="text-xs text-neutral-500 dark:text-neutral-400">
        
        
        Erstellt mit <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
          href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
      </p>
    
  </div>
  <div class="flex items-center justify-between">
    
  </div>

  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500"
  data-url="https://zyria.de/">
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800">
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          <span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span>
        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Suchen"
          tabindex="0">
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Schließen (Esc)">
        <span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>
</span>
      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

    </div>
  </body>
  
</html>
